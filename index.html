<!DOCTYPE html>
<html style="margin:0 0 0 0;height:100%;">
  <head>
    <meta charset="utf-8">
    <title>First Map Game</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="Scripts/LeafletJS/leaflet.css">
    <link rel="stylesheet" href="html.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script src="Scripts/LeafletJS/leaflet.js" type="text/javascript"></script>
  </head>
  <body style="margin:0 0 0 0;height:80%;">

    <div id="map"></div>

    <div id="control-panel">

      <div id="button-container">
        <button class="compass-button" id="n-compass-button">N</button>
        <button class="compass-button" id="ne-compass-button">NE</button>
        <button class="compass-button" id="e-compass-button">E</button>
        <button class="compass-button" id="se-compass-button">SE</button>
        <button class="compass-button" id="s-compass-button">S</button>
        <button class="compass-button" id="sw-compass-button">SW</button>
        <button class="compass-button" id="w-compass-button">W</button>
        <button class="compass-button" id="nw-compass-button">NW</button>
      </div>

      <button id="attack-button">Attack!</button>

      <div id="health-readout">
      </div>

      <div id="damage-readout">
      </div>

      <div id="game-condition">
      </div>

    </div>

    <script type="text/javascript">

    //Variables
    let mapSW = [0,4096];
    let mapNE = [4096,0];

    //Declare map object
    let map = L.map('map').setView([0,0],1);

    //Reference the tiles
    L.tileLayer('FirstMapGame/{z}/{x}/{y}.png', {
      minZoom: 1,
      maxZoom: 4,
      noWrap: true,
      crs: L.CRS.Simple
    }).addTo(map);

    map.setMaxBounds(new L.LatLngBounds(
      map.unproject(mapSW,map.getMaxZoom()),
      map.unproject(mapNE,map.getMaxZoom())
    ));

    //Place markers and allow for movement

    let markerIcon = L.icon({
      iconUrl: 'Images/tank1W.png',
      iconSize: [30,30],
      iconAnchor: [15,15],
      popupAnchor:[1,-15]
    });

    let alien1Icon = L.icon({
      iconUrl: 'Images/alien1N.png',
      iconSize: [30,30],
      iconAnchor: [15,15],
      popupAnchor:[1,-15]
    });

    let movedMarker;
    let compass = [
      ["n",0,-100],
      ["ne",75,-75],
      ["e",100,0],
      ["se",75,75],
      ["s",0,100],
      ["sw",-75,75],
      ["w",-100,0],
      ["nw",-75,-75]
    ]

    let marker = L.marker(map.unproject([2700,1700],map.getMaxZoom()),{icon:markerIcon}).addTo(map);
    let markerStats = {health: 100, dmg: 50};

    let alien1 = L.marker(map.unproject([3500,2500],map.getMaxZoom()),{icon:alien1Icon}).addTo(map);
    let alien1Stats = {health: 50, dmg: 20};

    let alien2 = L.marker(map.unproject([1000,1000],map.getMaxZoom()),{icon:alien1Icon}).addTo(map);
    let alien2Stats = {health: 50, dmg: 20};

    let alien3 = L.marker(map.unproject([900,3500],map.getMaxZoom()),{icon:alien1Icon}).addTo(map);
    let alien3Stats = {health: 50, dmg: 20};

    let moveMarker = function(markerVar,mapVar,xDiff,yDiff) {
      let latlngObj;
      latlngObj = mapVar.project(markerVar.getLatLng(),mapVar.getMaxZoom());
      latlngObj.x = (parseInt(latlngObj.x) + xDiff);
      latlngObj.y = (parseInt(latlngObj.y) + yDiff);
      markerVar.setLatLng(mapVar.unproject(latlngObj,mapVar.getMaxZoom()));
    };

    let alienAttack = function(markerVar,markerCoords,markerStats,alienVar,alienCoords,alienStats) {
      if(parseInt(markerCoords.distanceTo(alienCoords)) < 500 && alienStats.health > 0) {
        markerStats.health = markerStats.health - alienStats.dmg;
        markerStats.dmg = markerStats.dmg - Math.floor(Math.random()*10);
      }
    };

    let readoutUpdate = function(markerVar,markerStats) {
      $("#health-readout").html(markerStats.health);
      $("#damage-readout").html(markerStats.dmg);
    };

    let markerAttack = function(markerCoords,markerStats,alienCoords,alienStats) {
      if(parseInt(markerCoords.distanceTo(alienCoords)) < 500) {
        alienStats.health = alienStats.health - markerStats.dmg;
      }
      console.log(alienStats.health);
    };

    let checkGameCondition = function(markerStats,alienStatsArray) {
      if(parseInt(markerStats.health) < 1) {
        $("#game-condition").html("You lose!");
        return;
      }
      // if(parseInt(alienStats.health) < 1) {
      //   console.log("fired!");
      // }
      // if((parseInt(alienStats.health) > 1) && (parseInt(markerStats.health) > 1)){
      //   console.log("hi");
      //   return;
      // }
    }

    let alienMove = function(markerVar,alienVarArray,mapVar) {
      alienVarArray.forEach(function(alienVar) {
        let markerCoords = mapVar.project(markerVar.getLatLng(),mapVar.getMaxZoom());
        let alienCoords = mapVar.project(alienVar.getLatLng(),mapVar.getMaxZoom());
        let closestPoint = {x:0,y:0};
        let closestDirection;
        let tempAlienCoords = {x:0,y:0};
        compass.forEach(function(el) {
          if(!closestDirection) {
            closestDirection = el[0];
            closestPoint.x = alienCoords.x;
            closestPoint.y = alienCoords.y;
            closestPoint.x = closestPoint.x + el[1];
            closestPoint.y = closestPoint.y + el[2];
          } else {
            tempAlienCoords.x = alienCoords.x;
            tempAlienCoords.y = alienCoords.y;
            tempAlienCoords.x = tempAlienCoords.x + el[1];
            tempAlienCoords.y = tempAlienCoords.y + el[2];
            if(parseInt(markerCoords.distanceTo(tempAlienCoords)) <= parseInt(markerCoords.distanceTo(closestPoint))) {
              closestDirection = el[0];
              closestPoint.x = closestPoint.x + el[1];
              closestPoint.y = closestPoint.y + el[2];
            }
          }
        });
        alienVar.setLatLng(mapVar.unproject(closestPoint,mapVar.getMaxZoom()));
        console.log(parseInt(markerCoords.distanceTo(closestPoint)));
        if(parseInt(markerCoords.distanceTo(closestPoint)) > 1500) {
          alienVar.setOpacity(0);
        } else {
          alienVar.setOpacity(1);
        }
        alienAttack(markerVar,markerCoords,markerStats,alienVar,map.project(alienVar.getLatLng(),mapVar.getMaxZoom()),alien1Stats);
      });
    };


    //UPDATE METHODS (methods that update game state)

    let attackButton = document.getElementById('attack-button');
    attackButton.onclick = function() {
      markerAttack(map.project(marker.getLatLng(),map.getMaxZoom()),markerStats,map.project(alien1.getLatLng(),map.getMaxZoom()),alien1Stats);
      alienMove(marker,[alien1,alien2,alien3],map);
      readoutUpdate(marker,markerStats);
      checkGameCondition(markerStats,[alien1Stats,alien2Stats,alien3Stats]);
    };

    let nButton = document.getElementById('n-compass-button');
    nButton.onclick = function() {
      moveMarker(marker,map,0,-100);
      alienMove(marker,[alien1,alien2,alien3],map);
      readoutUpdate(marker,markerStats);
      checkGameCondition(markerStats,[alien1Stats,alien2Stats,alien3Stats]);
    };

    let neButton = document.getElementById('ne-compass-button');
    neButton.onclick = function() {
      moveMarker(marker,map,75,-75);
      alienMove(marker,[alien1,alien2,alien3],map);
      readoutUpdate(marker,markerStats);
      checkGameCondition(markerStats,[alien1Stats,alien2Stats,alien3Stats]);
    };

    let eButton = document.getElementById('e-compass-button');
    eButton.onclick = function() {
      moveMarker(marker,map,100,0);
      alienMove(marker,[alien1,alien2,alien3],map);
      readoutUpdate(marker,markerStats);
      checkGameCondition(markerStats,[alien1Stats,alien2Stats,alien3Stats]);
    };

    let seButton = document.getElementById('se-compass-button');
    seButton.onclick = function() {
      moveMarker(marker,map,75,75);
      alienMove(marker,[alien1,alien2,alien3],map);
      readoutUpdate(marker,markerStats);
      checkGameCondition(markerStats,[alien1Stats,alien2Stats,alien3Stats]);
    };

    let sButton = document.getElementById('s-compass-button');
    sButton.onclick = function() {
      moveMarker(marker,map,0,100);
      alienMove(marker,[alien1,alien2,alien3],map);
      readoutUpdate(marker,markerStats);
      checkGameCondition(markerStats,[alien1Stats,alien2Stats,alien3Stats]);
    };

    let swButton = document.getElementById('sw-compass-button');
    swButton.onclick = function() {
      moveMarker(marker,map,-75,75);
      alienMove(marker,[alien1,alien2,alien3],map);
      readoutUpdate(marker,markerStats);
      checkGameCondition(markerStats,[alien1Stats,alien2Stats,alien3Stats]);
    };

    let wButton = document.getElementById('w-compass-button');
    wButton.onclick = function() {
      moveMarker(marker,map,-100,0);
      alienMove(marker,[alien1,alien2,alien3],map);
      readoutUpdate(marker,markerStats);
      checkGameCondition(markerStats,[alien1Stats,alien2Stats,alien3Stats]);
    };

    let nwButton = document.getElementById('nw-compass-button');
    nwButton.onclick = function() {
      moveMarker(marker,map,-75,-75);
      alienMove(marker,[alien1,alien2,alien3],map);
      readoutUpdate(marker,markerStats);
      checkGameCondition(markerStats,[alien1Stats,alien2Stats,alien3Stats]);
    };

    </script>

  </body>
</html>
